<analysis>**original_problem_statement:**
The user, representing a 50-person consulting organization, requires a comprehensive business management application. The system needs to cover HR, Marketing, Sales, Finance, and Consulting project workflows.

**PRODUCT REQUIREMENTS (based on user clarifications):**
-   **Authentication & Roles:** Email-based login with roles: Admin, Manager, Executive, Consultant, Project Manager, and Principal Consultant. A separate page for user profile and rights configuration is required, to be integrated with a future HR module.
-   **Sales Workflow:** A detailed sales process from lead entry to agreement approval. The flow is: Lead → Pricing Plan → SOW → Quotation → Agreement → Approval.
-   **Scope of Work (SOW):**
    -   SOW is created by the sales team after the pricing plan.
    -   SOW has categories (Sales, HR, etc.) and version history for all changes.
    -   Requires a list view with trackable status (updatable by user, approved by manager) and a feature to upload external documents.
    -   SOW items can be assigned to a specific consultant and have optional backend support staff.
    -   Ability to add SOW items in a spreadsheet-like inline manner.
    -   Roadmap and Gantt views for timeline visualization.
    -   SOW document uploads are per-line-item and trigger email notifications upon completion.
    -   **NEW:** A two-step approval process where users submit selected SOW items (via checkboxes) to a manager, who then approves them and authorizes them to be sent to the client.
-   **SOW Linkages:** SOW should be linked to consultant performance and the overall project roadmap.
-   **Agreement & Export:** The agreement should be a structured document and be exportable to Word and PDF.
-   **Consultant & Project Management:** A Gantt chart with drag-and-drop task management is required.
-   **Integrations:** Rocket Reach integration for lead generation.

**User's preferred language**: English

**what currently exists?**
A full-stack application with a React frontend and FastAPI backend using MongoDB.
-   **Authentication & Roles:** JWT-based authentication is implemented with all requested roles.
-   **User Profile:** A My Profile page allows users to view and edit their information.
-   **Sales Workflow:** The revised workflow (Lead → Pricing Plan → SOW Builder → etc.) is implemented.
-   **SOW Management:** A highly advanced SOW builder is in place. It supports:
    -   Spreadsheet-style inline editing for adding and updating SOW items.
    -   Assignment of consultants and backend support staff to each item.
    -   List, Roadmap, and Gantt chart views for visualization.
    -   Per-item document uploads, which trigger email notifications when an item is marked Completed.
    -   A fully functional version history viewer that shows changes and a snapshot of SOW items at each version.
-   **Project Management:** A task management system, handover alerts for managers, and a kick-off meeting scheduler are all functional.

**Last working item**:
-   **Last item agent was working:** The user requested a new, more robust two-step approval workflow for SOW items. The agent acknowledged the request but has not started implementation.
-   **Status:** NOT STARTED
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both (This is a significant feature affecting UI and backend logic).
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Implement Two-Step SOW Approval Workflow (P0)**

**Issues Detail:**
-   **Issue 1:** Implement Two-Step SOW Approval Workflow
    -   **Attempted fixes:** None. The feature was just requested.
    -   **Next debug checklist:**
        1.  **Backend ( & ):**
            -   Update the SOW item model to include new approval statuses (e.g., , , ).
            -   Create an API endpoint to handle batch submission of SOW items for manager approval.
            -   Create an API endpoint for managers to approve individual or multiple items.
            -   Create a final API endpoint for managers to authorize approved items to be sent to the client.
        2.  **Frontend ():**
            -   Add a checkbox to each row in the SOW list view table.
            -   Implement a Submit for Approval button that sends the selected item IDs to the backend.
            -   Conditionally render Approve and Authorize for Client buttons in the UI, visible only to managers for items in the correct state.
            -   Update the status display logic to reflect the new, multi-step approval statuses.
    -   **Why fix this issue and what will be achieved with the fix?** This will implement a critical user requirement for a double-check mechanism, ensuring SOWs are properly vetted before being finalized and sent to clients.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) SOW linkages with consultant performance and project roadmap.** (User request #59).
    -   **(P1) Gantt Chart Integration:** Refine the Gantt chart on the  page using .
    -   **(P1) Agreement Export:** Implement backend logic to export the agreement to Word and PDF.
    -   **(P1) SOW Monthly Roadmap & RACI Matrix:** Convert the frozen SOW into a monthly roadmap format with a RACI matrix.
    -   **(P2) Rocket Reach Integration:** Integrate with Rocket Reach for lead enrichment.
-   **Future Tasks:**
    -   HR Module
    -   Detailed Time Tracking
    -   Custom Reporting Module
    -   Marketing Workflow Module
    -   Finance and Accounts Flow Module

**Completed work in this session**
-   **SOW Enhancements Implementation & Verification:** Confirmed that a set of previously in-progress SOW features (list view, status updates, doc uploads) were already complete and functional.
-   **SOW Version History Bug Fix:** Resolved a critical bug where the version history dialog failed to display the content of a selected version snapshot. The UI now correctly renders all items as they existed in that version.
-   **Spreadsheet-Style SOW Editor (Major Feature):**
    -   Implemented inline row creation, allowing users to add new SOW items directly within the table.
    -   Added functionality to assign a lead **Consultant** and optional **Backend Support** staff to each SOW item via dropdowns.
    -   Integrated **Roadmap** and **Gantt Chart** views for timeline and project visualization.
-   **Refactored SOW Document Handling:**
    -   Moved document uploads from a general SOW section to be attachments for each specific line item.
    -   Implemented backend logic to **automatically send email notifications** to managers and clients when an SOW item with attached documents is marked as Completed.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1:** Potential for syntax errors when using  or .
    -   **Debug checklist:** Visually inspect content being written for syntax correctness.
    -   **Why to solve this issue and what will be achieved with this?** Prevents breaking the application and avoids time spent on simple syntax bug hunts.
    -   **Should Test frontend/backend/both after fix:** both
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, Shadcn/UI
-   **Backend:** FastAPI, Pydantic, Motor (async MongoDB)
-   **Database:** MongoDB
-   **Authentication:** JWT with role-based access control
-   **File Uploads:** Handled via FastAPI .

**key DB schema**
-   **users**: {email, password, role, name, ...}
-   **sows**: {lead_id, version, items: [{id, title, category, timeline, deliverables, status, **consultant_id**, **support_staff: [{user_id, role}]**, **start_week**, **duration**, attachments: [{filename, url}]}], manager_approval_status, ...}
-   **sow_versions**: Stores historical snapshots of SOWs.
-   **agreements**: {..., sow_id, ...}
-   **tasks**: {project_id, title, status, ...}

**changes in tech stack**
-   User has requested using  for the main project tasks page. This still needs to be installed (yarn add v1.22.22
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
[4/4] Building fresh packages...
success Saved 1 new dependency.
info Direct dependencies
└─ react-gantt-timeline@0.4.3
info All dependencies
└─ react-gantt-timeline@0.4.3
Done in 21.44s.).

**All files of reference**
-   : The main FastAPI application file. Contains logic for SOW manipulation, document handling, and user management. It is becoming monolithic.
-   : Contains all Pydantic models for the sales process, including the recently expanded SOW item model.
-   : The heavily modified UI for the advanced SOW builder. **This file will need further changes for the new approval workflow.**
-   : UI for the task management system. Needs the  integration.

**Areas that need refactoring**:
-   The  file is extremely large and complex. It should be broken down into separate FastAPI routers for each domain (e.g., , , , ) to improve maintainability. This should be proposed to the user after the current task.

**key api endpoints**
-   : (NEW) POST to add multiple SOW items at once for spreadsheet-style editing.
-   : (UPDATED) PUT to update item status; now triggers email notifications on Completed.
-   : POST to upload documents to a specific SOW item.
-   : GET to download a document.
-   : GET to populate consultant dropdowns.

**Critical Info for New Agent**
-   **Immediate Priority:** Your first task is to implement the new two-step SOW approval workflow as detailed in the . This is the user's latest request and is P0.
-   **Refactoring Needed:** The  monolith is a growing concern. After completing the approval workflow, you should plan and propose a refactoring effort to split it into routers.
-   **Context:** The agent has successfully implemented several major, complex features on the  page. The code is fresh but intricate. Read the file carefully before making changes.

**documents and test reports created in this job**
-    (updated multiple times)

**Last 10 User Messages and any pending HUMAN messages**
-   **wait , send for approval should have checkbox...**: User requested a new two-step approval workflow for SOWs with checkboxes and manager authorization. (Status: **PENDING - THIS IS THE NEXT TASK**)
-   **upload document should not have its seperate section...**: User requested that document uploads be per-SOW-item and trigger emails on completion. (Status: **COMPLETED**)
-   **Spreadsheet-style inline editing...**: User clarified requirements for the SOW editor, including consultant/support assignment and roadmap views. (Status: **COMPLETED**)
-   **can we have some system can continue adding lines in the same window...**: User requested spreadsheet-style editing and linkage to consultant performance/roadmap. (Status: **Partially Completed** - inline editing done, linkages are upcoming)
-   **in this window view option dont reflect anything...**: User reported a bug where the SOW version history view was blank. (Status: **COMPLETED**)

**Project Health Check:**
-   **Broken:** None. The application is stable.
-   **Mocked:**
    -   Email sending uses a log-based placeholder; no actual emails are sent.
    -   The agreement export to Word/PDF is not yet implemented.

**3rd Party Integrations**
-   **react-gantt-timeline:** Requested for task management, but not yet installed or integrated.
-   **Rocket Reach:** Requested, but not yet implemented.

**Testing status**
-   **Testing agent used after significant changes:** NO. Agent self-tested recent features using  for the backend and  for the frontend.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** None.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Manager:**  / 
-   **Executive:**  / 

**What agent forgot to execute**
-   The agent did not start implementing the **two-step SOW approval workflow** requested by the user in the last message.
-   The agent has not yet proposed the high-priority refactoring of the monolithic  file.</analysis>
