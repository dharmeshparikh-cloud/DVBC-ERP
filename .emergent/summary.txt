<analysis>**original_problem_statement:**
The user requires a comprehensive business management application for a 50-person consulting organization covering HR, Marketing, Sales, Finance, and Consulting projects.

**PRODUCT REQUIREMENTS (based on user clarifications):**
-   **Authentication & Roles:** A comprehensive, customizable role and permissions management system, including Google Auth.
-   **Top-Down Sales Workflow:** A sales process where the salesperson inputs the , and the system auto-allocates costs and calculates the rate-per-meeting for each team member based on admin-defined rules. The flow is Pricing Plan → SOW → Quotation → Agreement → Approval.
-   **Project Kickoff Workflow:** A formal handover process from Sales to Consulting. The consulting team must not have visibility into any project pricing, costing, or financial data.
-   **Dynamic & Role-Specific Dashboards:** Users should see dashboards tailored to their department.
-   **Modules:** Employees, Client Master, Expenses, Reporting, Meetings & MOM, HR (Leave, Attendance, Payroll), My Workspace, Project Management, and a new **Admin Masters** module for managing core business rules (e.g., cost allocation percentages).
-   **P&L / Variance Tracking:** The ability to flag projects where actual delivery (e.g., number of meetings held) exceeds the committed scope, impacting profitability.

**User's preferred language**: English

**what currently exists?**
A full-stack application with a sales funnel (Pricing Plan -> Quotation -> Agreement). The agent has just completed a major architectural refactor to ensure the **Pricing Plan** is the single source of truth for project scope and team deployment, with data flowing down to Quotations and Agreements.

However, immediately after this was fixed, the user requested a fundamental change in the pricing model itself. The current system uses a bottom-up approach (defining rates and meetings to calculate a total). The new requirement is for a top-down model where the salesperson inputs a single  value, and the system reverse-calculates the per-meeting rates for team members based on pre-defined allocation percentages. The agent has received approval for a plan to implement this new logic.

**Last working item**:
-   **Last item agent was working:** The agent was preparing to start the implementation of the new top-down or reverse pricing logic, beginning with the creation of a new **Admin Masters** module to store allocation rules. This is the first step of the P0 task list approved by the user.
-   **Status:** NOT STARTED
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Implement P0 Sprint: Top-Down Pricing Redesign (P0)**
-   **Issue 2: Complete Workflow & Dashboard Redesign (P2)**
-   **Issue 3: Monolithic  file (P3 - Tech Debt)**

**Issues Detail:**
-   **Issue 1: Implement P0 Sprint: Top-Down Pricing Redesign**
    -   **Attempted fixes:** The agent has created a detailed implementation plan which the user has approved. No code has been written for this specific task yet.
    -   **Next debug checklist:**
        1.  **Backend:** Create a new Masters module (new router, e.g.,  and models) for managing  and their corresponding  (e.g., Full-time = 70%, Weekly = 20%).
        2.  **Frontend:** Create a new UI page for Admin users to manage these masters (CRUD operations).
        3.  **Frontend:** Rewrite the  component:
            -   The primary input should now be .
            -   When adding team members, the system should fetch the allocation percentage from the Masters based on the selected .
            -   The  (Total Investment * Allocation %) and  (Breakup / Total Meetings) should be auto-calculated and displayed as read-only fields.
            -   Add validation to ensure total allocation percentages sum to 100%.
        4.  **Testing:** Ensure the entire flow (Pricing Plan -> Quotation -> Agreement) works with the new top-down model.
    -   **Why fix this issue and what will be achieved with the fix?** To align the application with the user's core business process for pricing projects, enabling a top-down budgeting approach and setting the foundation for future P&L analysis.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

-   **Issue 2: Complete Workflow & Dashboard Redesign**
    -   **Next debug checklist:**
        1.  Design and implement the Consulting Efficiency Scorecard dashboard.
        2.  Create dashboards for other departments (HR, Finance).
    -   **Why fix this issue and what will be achieved with the fix?** To fulfill the core request for a fully dynamic, role-specific application experience.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** Issue 1: Implement P0 Sprint: Top-Down Pricing Redesign

-   **Issue 3: Monolithic  file**
    -   **Next debug checklist:**
        1.  Create a  directory in .
        2.  Move related models and endpoints from  into separate router files (e.g., , ).
        3.  Update  to use .
    -   **Why fix this issue and what will be achieved with the fix?** To improve code maintainability and scalability.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   None. The previous task was completed, and the new P0 task has not yet started.

**Upcoming and Future Tasks**
-   **Upcoming Tasks (P1):**
    -   **P&L Variance Tracking:** Implement logic to flag over-delivery (actual vs. committed meetings) during project execution.
    -   **Employee Cost Integration:** Integrate with HR/Payroll data to pull actual employee CTC for P&L calculations.
    -   **Project P&L Dashboard:** Create a dashboard showing committed vs. actual costs and revenue with variance alerts.
    -   **Masters Sync Engine:** Ensure all forms across the application are automatically updated when an admin changes data in the Masters module.
-   **Future Tasks (P2):**
    -   **Finance Module:** Build out a full finance module for P&L, invoicing, and revenue recognition.
    -   **Detailed Reporting:** Create reports for role-wise and client-wise profitability.
    -   **Real Email Integration (SMTP).**
    -   **Rocket Reach Integration.**

**Completed work in this session**
-   **Architectural Refactor of Sales Funnel:**
    -   Identified and fixed a major architectural flaw where pricing logic resided in the  module instead of the .
    -   Made the **Pricing Plan** the single source of truth for team deployment and cost calculations.
    -   Moved frequency-based meeting calculations and team structure definition to .
    -   Modified  and  to inherit and display this data as read-only, ensuring data consistency.
    -   Updated backend models in  to reflect the new data structure.
-   **Initial UI Enhancements (Superseded but completed):**
    -   Implemented auto-calculation for  based on frequency and tenure.
    -   Converted several text inputs to dropdowns for data consistency.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Monolithic  file.**
    -   **Debug checklist:** Plan and execute the refactoring of  into separate FastAPI routers.
    -   **Why to solve this issue and what will be achieved with this?** To improve code maintainability and scalability.
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   The monolithic  file remains a recurring technical debt issue.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, Shadcn/UI, Controlled Components, , .
-   **Backend:** FastAPI, Pydantic, Motor (async MongoDB).
-   **Architecture:** Single source of truth data flow (Pricing Plan -> Quotation -> Agreement). The next step is to implement a top-down calculation model.

**key DB schema**
-   **PricingPlan ():** The schema was significantly updated. It now contains a  field, making it the primary container for the detailed project team structure and pricing logic.
-   **Quotation/Agreement:** These models now link to a  to inherit the team and pricing details.

**All files of reference**
-   : **This file will be rewritten** for the new top-down pricing logic.
-   : Will need verification to ensure it correctly displays data from the new pricing model.
-   : Same as Quotations.
-   : Will likely need minor adjustments for the new pricing fields.
-   **(New Files to be created):** Backend router and models for the Admin Masters module, and a corresponding frontend page.

**Areas that need refactoring**:
-    needs to be broken down into smaller router files.
-   The entire pricing logic in  is about to be refactored again to support the top-down model.

**key api endpoints**
-   : Handles the creation of complex pricing plans with the full team deployment structure.
-   : Fetches plans to be linked in Quotations and Agreements.
-   **(New Endpoints to be created):** Full CRUD endpoints for the new **Admin Masters** module (e.g., ).

**Critical Info for New Agent**
-   **STOP! Do not continue the old pricing logic.** The user has mandated a complete shift from a bottom-up to a top-down pricing model.
-   Your **first task (P0)** is to implement this new model. This involves two main parts:
    1.  **Build an Admin Masters module:** Create backend APIs and a frontend UI for admins to define  (e.g., Tenure Type 'Weekly' gets a 20% allocation).
    2.  **Rewrite the Pricing Plan Builder:** The main input must be . The system must then use the rules from the Masters module to automatically calculate and display the allocated cost and per-meeting rate for each team member. These calculated fields must be **read-only** for the salesperson.
-   This is a major architectural change. Start with the backend Masters module first.

**documents and test reports created in this job**
-    (Updated with recent flow changes, needs updating again for the new top-down model).

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Requests auto-calculation of  and an editable  field. (Completed)
2.  **Agent:** Implements the feature in the  file. (Completed)
3.  **User:** Points out this is an architectural mistake; the logic should originate in the , not the . (Key Insight)
4.  **Agent:** Acknowledges the flaw and proposes a new, correct data flow (Pricing Plan -> Quotation -> Agreement). (Correction)
5.  **User:** yes (Approval for refactor)
6.  **Agent:** Implements the major architectural refactor, making the Pricing Plan the source of truth. (Completed)
7.  **User:** After seeing the fix, introduces a brand new top-down pricing requirement where the salesperson only inputs . (New Major Requirement)
8.  **Agent:** Analyzes the new top-down model, proposes an implementation strategy (Admin Masters for rules, reverse calculation), and asks clarifying questions.
9.  **User:** Confirms the agent's understanding, clarifies rules (e.g., rate override is NOT allowed), and explicitly requests the creation of a masters module.
10. **Agent:** Creates a detailed task list (P0, P1, P2) for the new feature set and asks for confirmation to start.
11. **User (Pending):** yes go ahead with PO for now and remind me go in P1 afterwords (Approval to start P0)

**Project Health Check:**
-   **Broken:** None.
-   **Mocked:** Email sending functionality.
-   **Needs Rework:** The entire pricing calculation logic needs to be rebuilt as per the new top-down model. The  monolith remains critical technical debt.

**3rd Party Integrations**
-   **Emergent-managed Google Auth**
-   **DHTMLX Gantt** (Mentioned in original spec, not yet implemented)
-   **Rocket Reach** (Requested, not implemented)

**Testing status**
-   **Testing agent used after significant changes:** NO. The last major refactor was only tested manually with screenshots. The next implementation will require a full test run.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Manager:**  / 
-   **Executive:**  / 

**What agent forgot to execute**
-   The agent correctly pivoted to each of the user's major architectural changes. However, after the last significant refactor (making Pricing Plan the source of truth), a full regression test using the  was not performed before moving on to planning the next feature. This should be done after the next P0 implementation.</analysis>
