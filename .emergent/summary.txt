<analysis>**original_problem_statement:**
The user is building a comprehensive business management ERP. The initial goal was a Sales to Consulting workflow, but priorities shifted to a major architectural refactor of the permission system, followed by significant enhancements to the HR and authentication modules.

**Recent User Requirements:**
1.  **(P0) Enhance Onboarding Flow:** Based on an Excel file (), make all onboarding fields mandatory and add several new ones.
2.  **(P0) New Onboarding Workflow:** After an HR/Admin confirms a new employee's details in a final pop-up, the app should auto-redirect to a Payroll Builder / Design CTC page. After CTC approval, it should prompt the user to optionally go to a Document Builder page.
3.  **(P0) CSV Bulk Upload:** Add a Quick Import step to the beginning of the onboarding process to allow bulk employee creation via CSV upload.
4.  **(P0) Document Builder:** Create a new page where HR can generate employment letters for onboarded employees using pre-built templates.
5.  **(P1) Admin Approval for Edits:** Employee records, once created, should only be modifiable with an admin's approval.
6.  **(P1) Downloadable Documents:** Allow uploaded documents in the onboarding process to be downloaded.

**User's preferred language**: English

**what currently exists?**
The application features a simplified permission model (based on Department and Reporting Hierarchy), a functional sales flow, and a robust authentication system allowing login via Employee ID. The core data model has been consolidated, with  as the master record and  as the linked authentication record, consistently using  as the key. The HR onboarding process was recently enhanced with a Quick Import CSV feature, but the implementation of further user requests for this flow is incomplete and has left the component in a broken state.

**Last working item**:
- **Last item agent was working:** Implementing a major overhaul of the  page. The agent was adding numerous new fields from a user-provided Excel sheet, making all fields mandatory, and trying to restructure the multi-step form logic.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** both. The frontend  component needs significant UI/UX testing, and the backend needs to support the new fields and the proposed modification approval workflow.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1 (P0):  component is broken and incomplete.**
- **Issue 2 (P1): Complete  Refactoring.**

**Issues Detail:**
- **Issue 1:  component is broken and incomplete.**
    - **Attempted fixes:** The agent added a new Quick Import step (Step 0), which required re-numbering all subsequent steps. This led to errors from duplicated code blocks and incorrect  statements in the  and  functions. The agent was attempting to fix these sequentially but was getting stuck due to the file's complexity. The implementation of new fields from the Excel file and the new post-onboarding workflow has not been completed.
    - **Next debug checklist:**
        1.  Gain a clear understanding of the file by viewing  in its entirety.
        2.  Systematically add all new fields from  to the  state object.
        3.  Implement the department-based probation period logic (3 months for non-consulting, 6 months for consulting) in a  hook.
        4.  Thoroughly refactor the  and  functions to correct the step numbering (now 0-6) and add the new mandatory fields to their respective steps and validation checks.
        5.  Implement the post-onboarding confirmation pop-up.
    - **Why fix this issue and what will be achieved with the fix?** This is a critical user request that will complete the core HR onboarding module according to the new, more detailed specifications.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** both
- **Issue 2: Complete  Refactoring**
    - **Attempted fixes:** Some logic has been moved to routers, but the file remains monolithic and contains legacy / checks.
    - **Next debug checklist:** Use  to find and systematically purge all remaining legacy permission checks. Identify the next logical group of endpoints (e.g., projects, finance) and migrate them to a new router file in .
    - **Why fix this issue and what will be achieved with the fix?** To improve backend maintainability, reduce technical debt, and prevent conflicts with the new permission system.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** backend

**In progress Task List**:
- **Task 1: Implement the full Onboarding-to-CTC-to-Document-Builder flow (P0)**
    - **Where to resume:** The  file needs to be fixed first. Then, the new pages (, ) and the routing logic between them must be created.
    - **What will be achieved with this?** A seamless, end-to-end HR workflow from initial data entry to payroll setup and document generation, as specified by the user.
    - **Status:** BLOCKED
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on something:** Issue 1:  component is broken and incomplete.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **(P0)** Create the Payroll Builder / Design CTC page.
    - **(P0)** Create the Document Builder page for generating employment letters.
    - **(P1)** Implement the admin approval workflow for modifying employee records by updating the  endpoint.
    - **(P1)** Add a download button for documents uploaded during onboarding.
- **Future Tasks:**
    - Build out the full Finance Module and Project P&L Dashboards.
    - Add low-priority workflows (Recruitment, Asset Management).
    - Implement a Day 0 guided onboarding tour for new users.
    - Implement an inbuilt Country Code Selector for mobile number inputs.
    - Address minor UI bugs (PWA install prompt, applying  to Sales Dashboard).

**Completed work in this session**
- **Data Model Consolidation:** Fixed critical data inconsistencies between the  and  collections. Established  (e.g., 'EMP001') as the reliable, primary key for linking the two, and created a migration script to fix historical data.
- **Employee ID Authentication:** Successfully implemented and tested a new login system allowing users to authenticate with their Employee ID and a pattern-based default password ().
- **Password Management Module:** Created a new Password Management page, accessible to Admin/HR, to view all employees, manage system access (enable/disable), and reset passwords.
- **Employee Dashboard Fixes:** Resolved bugs on the employee dashboard, ensuring stat scorecards display correct data and removing redundant Add Employee and Sync from Users buttons to enforce onboarding as the single entry point.
- **Refactored User Creation:** Simplified the onboarding backend logic to use a single, reliable  API call for user creation, removing previous error-prone calls.
- **E2E Flow Verification:** Successfully tested the end-to-end flow of onboarding a new employee and verifying they can log in and perform their job functions (e.g., a sales rep creating a lead).

**Earlier issues found/mentioned but not fixed**
- PWA Install Notification and Branding not implemented.
- The  component has not been applied to the Sales Dashboard widgets.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** The monolithic  file.
- **Recurrence count:** 12+
- **Status:** IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
- **Employee as Master Record:** The  collection is the source of truth for all HR data. The  collection is for authentication only and is linked via a consistent  field.
- **Stateful Multi-Step Form:** The  component manages a complex, multi-step user journey with a single large state object and step-by-step validation. Its current complexity is a source of bugs.
- **Derived Business Logic:** The application calculates certain fields based on others, such as determining an employee's  based on their assigned .

**key DB schema**
- ****: 
- ****: 
- ** (Proposed)**: 

**All files of reference**
-  (The primary file that needs to be fixed and completed)
- The user-provided artifact  (Contains the requirements for all new fields)
-  (For implementing the approval workflow and continued refactoring)
-  (Contains a summary of the data model decisions)

**Areas that need refactoring**:
- ****: This component has become excessively large and difficult to manage. After fixing the immediate bugs, it should be broken down into smaller, step-specific sub-components to improve maintainability.
- ****: This remains a high-priority refactoring target to be broken down into domain-specific routers.

**key api endpoints**
- **Modified:**
    - : Accepts  in addition to .
    - : Slated for modification to include an approval workflow.
- **New:**
    - : Resets an employee's password.
    - : Enables or disables an employee's system access.
- **Proposed:**
    - : To handle the CSV import feature.

**Critical Info for New Agent**
- Your immediate and highest priority task is to **fix the broken  component**. The previous agent got stuck after adding a Quick Import step, which caused cascading errors in the step-by-step logic. You must meticulously refactor the  and  functions to align with the new 7-step structure (0-6) and integrate all the new mandatory fields from the user's Excel file.
- The user has defined a new, critical E2E workflow that must be built: **Onboarding Confirmation -> Auto-Redirect to CTC Builder -> Optional Redirect to Document Builder**. This requires creating two new pages (, ) and implementing the navigation logic.
- The data model has been standardized around  (e.g., EMP001). Ensure all new features and fixes adhere to this by using  as the primary identifier for linking employees and users.

**documents and test reports created in this job**
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Is the  linked E2E in all flows (Sales, Consulting)?
2.  **Agent:** Confirmed the linkage is correct via UUIDs, which map back to the employee.
3.  **User:** Requested verification of the full onboarding E2E flow.
4.  **Agent:** Onboarded a test employee () and confirmed they could log in and access the Sales module correctly.
5.  **User:** Requested enhancements: make all onboarding fields mandatory, add admin approval for edits, add document download options, and add a CSV bulk upload feature.
6.  **Agent:** Began implementing the enhancements.
7.  **User:** Provided an Excel file () with the full field list and requested a new post-onboarding flow (Confirmation -> CTC Builder -> Document Builder).
8.  **Agent:** Analyzed the file and confirmed understanding.
9.  **User:** Clarified logic: probation period (3/6 months), Document Builder is optional, Previous Employment is part of the documents step.
10. **Agent:** Agreed and began the implementation, which is currently in a broken, in-progress state.

**Project Health Check:**
- **Broken:**
    - : The component is non-functional due to an incomplete and buggy refactor.
- **Needs Rework:**
    - : Still requires significant refactoring to break it out of its monolithic structure.
- **Mocked / Not Started:**
    - The Payroll Builder / Design CTC page.
    - The Document Builder page.
    - The admin approval system for employee data changes.

**3rd Party Integrations**
- None added in this session.

**Testing status**
- **Testing agent used after significant changes:** YES (for features completed earlier in the session).
- **Test files created:** None.
- **Known regressions:** The entire HR Onboarding page is currently broken.

**Credentials to test flow:**
- **Admin:**  / 
- **HR Manager:**  / 

**What agent forgot to execute**
The agent got overwhelmed by the complexity of modifying the monolithic  file. They did not complete the user's request to add all mandatory fields from the Excel file or build out the new post-onboarding workflow (CTC Builder, Document Builder). The file was left in a broken state.</analysis>
